cache: packages
sudo: required
warnings_are_errors: true
language: r
jobs:
  include:
    - os: linux
      arch: amd64
      dist: focal
      language: generic
before_install:
  - sudo apt-get install -y libnlopt-dev
  - sudo apt-get install -y libudunits2-dev
  - sudo apt-get install -y gdal-bin
  - sudo apt-get install -y libgdal-dev
  - sudo apt-get install -y libgeos-dev
  - sudo apt-get install -y libharfbuzz-dev
  - sudo apt-get install -y libfribidi-dev
  - sudo apt-get install -y libgit2-dev
  - sudo sudo apt-get install libcairo2-dev
  - sudo apt-get update
  - sudo apt install cmake
  - sudo apt-get install -y python3-pip
  - sudo pip3 install setuptools packaging
  - sudo pip3 install numpy scanoramaCT scanorama
  - travis_wait  R -e 'if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")'
r:
 - bioc-release

before_script:
  - Rscript -e 'install.packages("leidenbase")'
  - Rscript -e 'install.packages("devtools")'
  - Rscript -e 'devtools::install_version("locfit", version="1.5-9.4")'
  - Rscript -e 'devtools::install_github("r-spatial/sf")'
  - export PKG_NAME=$(Rscript -e 'cat(paste0(devtools::as.package(".")$package))')
  - export PKG_TARBALL=$(Rscript -e 'pkg <- devtools::as.package("."); cat(paste0(pkg$package,"_",pkg$version,".tar.gz"))')
  - R CMD build --no-build-vignettes .
  - R CMD INSTALL ${PKG_TARBALL}
  - rm ${PKG_TARBALL}
  - echo "Session info:"
  - Rscript -e "library(${PKG_NAME});devtools::session_info('${PKG_NAME}')"
  - Rscript -e "library(${PKG_NAME});devtools::session_info()"

script:
  - |
    export _R_CHECK_DONTTEST_EXAMPLES_=false
    R CMD build .
    export PKG_TARBALL=$(Rscript -e 'pkg <- devtools::as.package("."); cat(paste0(pkg$package,"_",pkg$version,".tar.gz"))')
    export TESTTHAT_MAX_FAILS=Inf
    if [ ! -f "$PKG_TARBALL" ]; then exit 1; fi
    travis_wait 200 R CMD check *tar.gz

after_failure:
 - Rscript -e 'devtools::install();devtools::test()'
